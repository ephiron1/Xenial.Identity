@page "/Admin2/User/{UserId}"
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using MudBlazor.Utilities
@using Newtonsoft.Json
@using Xenial.Identity.Data
@using Xenial.Identity.Infrastructure
@inject UserManager<XenialIdentityUser> UserManager
@inject ISnackbar Snackbar

<MudText Typo="Typo.h3" GutterBottom>User</MudText>

@if (User is not null)
{
    <MudContainer MaxWidth="MaxWidth.Small">
        <MudStack>
            <MudPaper Class="pa-4">
                <MudStack Row="true">
                    <UserAvatar User="@User" Size="Size.Large" />
                    <MudStack Justify="Justify.Center" Spacing="0">
                        <MudText Typo="Typo.body1">@User.DisplayName</MudText>
                        <MudText Typo="Typo.body2">@User.Email</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>

            <MudTabs Elevation="4" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                <MudTabPanel Text="Name" Icon="@Icons.Filled.Person">
                    <MudStack Spacing="4">
                        <MudStack Row>
                            <MudTextField Label="Firstname"
                                      Variant="Variant.Filled"
                                      FullWidth
                                      Margin="Margin.Dense"
                                      @bind-Value="@User.FirstName" />

                            <MudTextField Label="LastName"
                                      Variant="Variant.Filled"
                                      FullWidth
                                      Margin="Margin.Dense"
                                      @bind-Value="@User.LastName" />
                        </MudStack>
                        <MudTextField Label="Fullname"
                                  Variant="Variant.Filled"
                                  FullWidth
                                  Margin="Margin.Dense"
                                  @bind-Value="@User.FullName" />

                        <MudTextField Label="Company"
                                  Variant="Variant.Filled"
                                  Margin="Margin.Dense"
                                  @bind-Value="@User.CompanyName" />

                    </MudStack>
                </MudTabPanel>
                <MudTabPanel Text="Address" Icon="@Icons.Filled.LocationCity">
                    <MudStack Spacing="4">
                        <MudTextField Label="Address 1"
                                  Variant="Variant.Filled"
                                  Margin="Margin.Dense"
                                  @bind-Value="@User.AddressStreetAddress1" />

                        <MudTextField Label="Address 2"
                                  Variant="Variant.Filled"
                                  Margin="Margin.Dense"
                                  @bind-Value="@User.AddressStreetAddress2" />

                        <MudStack Row>
                            <MudTextField Label="Postalcode"
                                      Style="100px"
                                      Variant="Variant.Filled"
                                      Margin="Margin.Dense"
                                      Class="flex-grow-0"
                                      @bind-Value="@User.AddressPostalCode" />

                            <MudTextField Label="City"
                                      Variant="Variant.Filled"
                                      Margin="Margin.Dense"
                                      @bind-Value="@User.AddressLocality" />

                        </MudStack>
                        <MudStack Row>
                            <MudTextField Label="Region"
                                      Variant="Variant.Filled"
                                      Margin="Margin.Dense"
                                      @bind-Value="@User.AddressRegion" />
                            <MudTextField Label="Country"
                                      Variant="Variant.Filled"
                                      Margin="Margin.Dense"
                                      @bind-Value="@User.AddressCountry" />
                        </MudStack>
                    </MudStack>
                </MudTabPanel>
                <MudTabPanel Text="Appearance" Icon="@Icons.Filled.RemoveRedEye">
                    <MudStack Spacing="4">
                        <MudTextField Label="Initials"
                                  Variant="Variant.Filled"
                                  Margin="Margin.Dense"
                                  @bind-Value="@User.Initials" />

                        <MudColorPicker DisableToolbar="false"
                                    DisableAlpha="true"
                                    DisableColorField="false"
                                    DisablePreview="false"
                                    DisableSliders="false"
                                    DisableInputs="true"
                                    DisableModeSwitch="true"
                                    ColorPickerMode="ColorPickerMode.RGB"
                                    PickerVariant="PickerVariant.Dialog"
                                    Value="@color"
                                    ValueChanged="ColorChanged"/>

                    </MudStack>
                </MudTabPanel>
            </MudTabs>

            <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="async () => await SaveUser()">Save</MudButton>

        </MudStack>
    </MudContainer>


}
@code {
    [Parameter]
    public string UserId { get; set; }
    public XenialIdentityUser User { get; set; }
    public MudColor color;

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        await ReloadUser();
    }

    private void ColorChanged(MudColor newColor)
    {
        color = newColor;
        User.Color = newColor.ToString(MudColorOutputFormats.Hex);
    }

    protected async Task ReloadUser()
    {
        User = await UserManager.FindByIdAsync(UserId);
        if (User is not null)
        {
            color = new MudColor(User.Color);
        }
    }
}
